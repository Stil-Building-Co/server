#
# MDEV-19157 -Optimistic Parallel Replication fails when gtid_slave_pos table is non
#  transactional and binlog events are transactional
# Test if gtid_slave_pos is non transactional we are giving warning to user
#
--source include/have_binlog_format_row.inc
--source include/have_innodb.inc
--source include/master-slave.inc

--sync_slave_with_master
--source include/stop_slave.inc
--let $old_threads= `select @@GLOBAL.slave_parallel_threads`
--let $old_mode= `select @@GLOBAL.slave_parallel_mode`
SET GLOBAL slave_parallel_threads=8;
set global slave_parallel_mode=optimistic;
alter table mysql.gtid_slave_pos engine=myisam;
SET GLOBAL gtid_slave_pos = "0-1-100";


--connection slave
--source include/start_slave.inc
--let SEARCH_FILE= $MYSQLTEST_VARDIR/log/mysqld.2.err
--let SEARCH_PATTERN= Non transactional gtid_slave_pos table with Optimistic/Aggressive parallel
--echo #Only 1 warning
source include/search_pattern_in_file.inc;
--source include/stop_slave.inc
--eval SET GLOBAL slave_parallel_threads= $old_threads
--eval set global slave_parallel_mode=$old_mode

start slave;
--source include/rpl_end.inc

